# Access via "http://localhost:8080"
#   (or "http://$(docker-machine ip):8080" if using docker-machine)

version: '2.1'
services:
  drupal:
    image: naturalis/php-drupal:0.0.1
    restart: unless-stopped
    depends_on:
        db:
           condition: service_healthy
    env_file:
      - .env
    ports:
      - ${WEB_EXTERNAL_PORT:-8080}:80
    networks:
      - default
      - web
    volumes:
      - ${BASE_PATH:-/data}/config:/root/config
      - ${BASE_PATH:-/data}/www/drupal:/var/www/html
      - ${BASE_PATH:-/data}/www/log/apache2:/var/log/apache2
      - ${BASE_PATH:-/opt}/project:/opt/project
  db:
    image: "mysql:5.7"
    restart: unless-stopped
    environment:
        MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-drupaltest}
        MYSQL_DATABASE: ${MYSQL_DATABASE:-drupaldb}
        MYSQL_USER: ${MYSQL_USER:-drupaluser}
        MYSQL_PASSWORD: ${MYSQL_PASSWORD:-test123}
    networks:
        - default
    ports:
        - "${MYSQL_EXTERNAL_PORT:-3306}:3306"
    volumes:
        - ${BASE_PATH:-/data}/database/mysqlconf:/etc/mysql/conf.d
        - ${BASE_PATH:-/data}/database/initdb:/docker-entrypoint-initdb.d
        - ${BASE_PATH:-/data}/database/db:/var/lib/mysql
        - ${BASE_PATH:-/data}/database/mysqllog:/var/log/mysql
    healthcheck:
        test: mysql --user=root --password=${MYSQL_ROOT_PASSWORD} -e 'connect ${MYSQL_DATABASE:-drupaldb}'

# run docker network create web before
networks:
  web:
    external: true
