# Access via "http://localhost:8080"
#   (or "http://$(docker-machine ip):8080" if using docker-machine)

version: '3.4'

x-logging:
  &default-logging
  options:
    max-size: '10m'
    max-file: '5'
  driver: json-file

services:
  drupal:
    image: naturalis/php-drupal:${PHP_DRUPAL_TAG:-0.0.2}
    restart: unless-stopped
    depends_on:
        - db
    env_file:
      - .env
    ports:
      - ${WEB_EXTERNAL_PORT:-8080}:80
    networks:
      - default
      - web
    logging: *default-logging
    labels:
      - traefik.enable=true
      - traefik.http.routers.minio-insecure.entrypoints=http
      - traefik.http.routers.minio-insecure.rule=${DRUPAL_SITE_URL:-Host(`drupal-test.naturalis.nl`)}
      - traefik.http.routers.minio-insecure.middlewares=minio-redirectscheme@docker
      - traefik.http.middlewares.minio-redirectscheme.redirectscheme.scheme=https
      - traefik.http.middlewares.minio-redirectscheme.redirectscheme.permanent=true
      - traefik.http.routers.minio.entrypoints=https
      - traefik.http.routers.minio.tls.certresolver=route53
      - traefik.http.routers.minio.tls=true
      - traefik.http.routers.minio.rule=${MINIO_URL_CONFIG:-Host(`drupal-test.naturalis.nl`)}
    volumes:
      - ${BASE_PATH:-/data}/www/drupal:/var/www/html
      - ${BASE_PATH:-/opt}/project:/opt/project
  db:
    image: "mysql:5.7"
    restart: unless-stopped
    environment:
        MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-drupaltest}
        MYSQL_DATABASE: ${MYSQL_DATABASE:-drupaldb}
        MYSQL_USER: ${MYSQL_USER:-drupaluser}
        MYSQL_PASSWORD: ${MYSQL_PASSWORD:-test123}
    networks:
        - default
    logging: *default-logging
    ports:
        - "${MYSQL_EXTERNAL_PORT:-3306}:3306"
    volumes:
        - ${BASE_PATH:-/data}/database/mysqlconf:/etc/mysql/conf.d
        - ${BASE_PATH:-/data}/database/initdb:/docker-entrypoint-initdb.d
        - ${BASE_PATH:-/data}/database/db:/var/lib/mysql
        - ${BASE_PATH:-/data}/database/mysqllog:/var/log/mysql
    healthcheck:
        test: mysql --user=root --password=${MYSQL_ROOT_PASSWORD} -e 'connect ${MYSQL_DATABASE:-drupaldb}'

  traefik:
    image: traefik:2.0.0
    container_name: traefik
    restart: unless-stopped
    environment:
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_HOSTED_ZONE_ID=${AWS_HOSTED_ZONE_ID}
    ports:
      - 80:80
      - 443:443
      - 8081:8080
    networks:
      - default
      - web
    logging: *default-logging
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${TRAEFIK_TOML_FILE:-./traefik.toml}:/traefik.toml
      - ./acme.json:/acme.json

# run docker network create web before
networks:
  web:
    external: true
